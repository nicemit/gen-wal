#!/usr/bin/env bash
set -e

echo "ðŸ§  Installing Gen-Wal..."

# --- OS Check ---
if ! grep -qiE "ubuntu|debian" /etc/os-release; then
  echo "âŒ Only Ubuntu/Debian supported for now."
  exit 1
fi

# --- Dependencies ---
echo "ðŸ“¦ Installing system dependencies..."
sudo apt update -qq
sudo apt install -y python3 python3-pip pipx curl wget jq fonts-dejavu-core git -qq

pipx ensurepath > /dev/null 2>&1 || true

# --- Clone/Update Repository ---
GENWAL_DIR="$HOME/gen-wal"
if [ -d "$GENWAL_DIR" ]; then
    echo "ðŸ“‚ Updating existing Gen-Wal repository..."
    cd "$GENWAL_DIR" && git pull
else
    echo "ðŸ“‚ Cloning Gen-Wal repository..."
    git clone https://github.com/nicemit/gen-wal.git "$GENWAL_DIR"
fi

# --- Install Python Dependencies ---
echo "ðŸ Installing Python libraries..."
pip3 install -r "$GENWAL_DIR/requirements.txt" --break-system-packages 2>/dev/null || \
pip3 install -r "$GENWAL_DIR/requirements.txt" --user

# --- Create Config Dirs ---
mkdir -p ~/.config/genwal
mkdir -p "$GENWAL_DIR/profiles"

# --- Interactive Setup ---
echo ""
echo "ðŸŽ¨ Let's set up your profile."
read -p "What's your name? (Default: User): " USER_NAME
USER_NAME=${USER_NAME:-User}

echo ""
echo "What is your main focus/vibe right now?"
echo "Examples: 'Ruthless Founder', 'Calm Stoic', 'Creative Artist', 'Disciplined Athlete'"
read -p "Your Focus (Default: Stoic): " FOCUS
FOCUS=${FOCUS:-Stoic}

read -p "Wallpaper refresh time (HH:MM, default 06:30): " TIME
TIME=${TIME:-06:30}

# --- Generate User Profile ---
PROFILE_PATH="$GENWAL_DIR/profiles/user_profile.md"
cat > "$PROFILE_PATH" <<EOF
# $USER_NAME's Gen-Wal Profile

## Core Identity
- **Name:** $USER_NAME
- **Current Focus:** $FOCUS

## Themes
- Discipline
- Consistency
- Growth
- Focus

## Preferred Styles
- Minimalist
- High Contrast
- Cinematic
EOF

echo "âœ… Created profile at $PROFILE_PATH"

# --- Generate Config ---
CONFIG_PATH="$GENWAL_DIR/config.yaml"
cat > "$CONFIG_PATH" <<EOF
# Gen-Wal Configuration

# Profile Settings
profile_provider: "local_file"
profile_path: "profiles/user_profile.md"

# Providers (Defaulting to Pollinations for zero-setup)
quote_provider: "pollinations:text" 
image_provider: "pollinations:image"
image_prompt_provider: "pollinations:text"

# Unified Pollinations Configuration
pollinations:
  image:
    model: "flux" 
    nologo: true
  text:
    model: "openai"

# Rendering
resolution:
  width: 1920
  height: 1080

text_position: "bottom_center"
text_padding: 80
font_size: 50

# Prompts
prompts:
  quote: |
    You are a motivational coach for $USER_NAME who is focused on $FOCUS. 
    Generate a single, short, punchy, direct motivational quote (max 20 words).
    Do not explain. Do not use quotes around the text.
    
    PROFILE:
    {profile_content}

  image_description: |
    Generate a concise visual description for an image to accompany this motivational quote. 
    Focus on abstract, nature, or technological themes fitting a $FOCUS vibe. No text in the image. 
    Max 15 words.
    
    QUOTE: {quote}
    PROFILE: {profile_content}

# Wallpaper Settings
wallpaper_settings:
  apply_wallpaper: true
  save_path: "~/.cache/gen-wal/current_wallpaper.jpg"
EOF

echo "âœ… Generated config.yaml"

# --- Install systemd ---
echo "â° Setting up daily timer ($TIME)..."
mkdir -p ~/.config/systemd/user
cat > ~/.config/systemd/user/genwal.service <<EOF
[Unit]
Description=Gen-Wal Wallpaper Generator

[Service]
ExecStart=/usr/bin/python3 $GENWAL_DIR/main.py
Environment="DISPLAY=:0"
Environment="DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u)/bus"
EOF

cat > ~/.config/systemd/user/genwal.timer <<EOF
[Unit]
Description=Run Gen-Wal Daily

[Timer]
OnCalendar=*-*-* ${TIME}:00
Persistent=true

[Install]
WantedBy=timers.target
EOF

systemctl --user daemon-reload
systemctl --user enable --now genwal.timer

echo ""
echo "âœ¨ Setup Complete! Gen-Wal is active."
echo "   - Config: $GENWAL_DIR/config.yaml"
echo "   - Profile: $PROFILE_PATH"
echo "   - Next run: Tomorrow at $TIME"
echo ""
echo "To run it immediately, type:"
echo "python3 ~/gen-wal/main.py"
