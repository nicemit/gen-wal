#!/bin/bash

# Gen-Wal CLI Helper
# Usage: genwal [command]

INSTALL_DIR="$HOME/.gen-wal"
CONFIG_FILE="$INSTALL_DIR/config.yaml"

# If not found in default location, check current directory (Dev Mode)
if [ ! -f "$CONFIG_FILE" ]; then
    if [ -f "./config.yaml" ]; then
        CONFIG_FILE="./config.yaml"
    else
        echo "‚ùå Could not find config.yaml in $INSTALL_DIR or current directory."
        exit 1
    fi
fi

case "$1" in
    config|edit)
        echo "üìù Opening config file: $CONFIG_FILE"
        ${EDITOR:-nano} "$CONFIG_FILE"
        ;;
    logs)
        echo "üìã Tailing logs (Ctrl+C to exit)..."
        journalctl --user -u gen-wal.service -f
        ;;
    run|now|start)
        shift # remove 'run' command
        
        # If arguments are provided (e.g. --text-pos), run interactively
        if [ "$#" -gt 0 ]; then
             echo "üöÄ Running interactively with args: $*"
             
             PYTHON_CMD="python3"
             if [ -f "$INSTALL_DIR/venv/bin/python" ]; then
                PYTHON_CMD="$INSTALL_DIR/venv/bin/python"
             fi
             
             # Run in INSTALL_DIR so imports work if needed, though main.py handles paths well
             cd "$INSTALL_DIR" || exit 1
             "$PYTHON_CMD" "main.py" --config "$CONFIG_FILE" "$@"
        else
             # No args? Just trigger the background service
             echo "üöÄ Triggering background run..."
             systemctl --user start gen-wal.service
             echo "Done. Check logs for progress: genwal logs"
        fi
        ;;
    profile)
        shift # remove 'profile'
        SUBCOMMAND="$1"
        shift # remove subcommand
        
        PYTHON_CMD="python3"
        if [ -f "$INSTALL_DIR/venv/bin/python" ]; then
           PYTHON_CMD="$INSTALL_DIR/venv/bin/python"
        fi
        
        case "$SUBCOMMAND" in
            list)
                cd "$INSTALL_DIR" || exit 1
                "$PYTHON_CMD" -c "from src.utils import list_profiles; import os; print('\n'.join(list_profiles('profiles')))"
                ;;
            edit)
                PROFILE_NAME="$1"
                if [ -z "$PROFILE_NAME" ]; then
                    echo "Usage: genwal profile edit <name>"
                    exit 1
                fi
                
                # Normalize name (remove extension if user added it)
                PROFILE_NAME="${PROFILE_NAME%.md}"
                PROFILE_PATH="profiles/$PROFILE_NAME.md"
                
                # Check if it exists
                if [ ! -f "$INSTALL_DIR/$PROFILE_PATH" ]; then
                    echo "üÜï Creating new profile: $PROFILE_NAME"
                    
                    # Create directory if it doesn't exist (e.g. profiles/custom)
                    mkdir -p "$(dirname "$INSTALL_DIR/$PROFILE_PATH")"
                    
                    # Write Template
                    cat > "$INSTALL_DIR/$PROFILE_PATH" <<EOF
---
quote_prompt_template: "Act as a [PERSONA]. Generate a [STYLE] quote. Max 15 words."
image_prompt_template: "Visualize a [STYLE] background. [COLORS]. Abstract."
---
# $PROFILE_NAME

[Keywords or core philosophy here]
EOF
                fi
                
                # Open Editor
                echo "üìù Opening editor..."
                ${EDITOR:-nano} "$INSTALL_DIR/$PROFILE_PATH"
                
                # Ask to switch
                echo ""
                read -p "üîÑ Switch to this profile now? [Y/n] " -n 1 -r
                echo ""
                if [[ $REPLY =~ ^[Yy]$ || -z $REPLY ]]; then
                     cd "$INSTALL_DIR" || exit 1
                    "$PYTHON_CMD" -c "from src.utils import update_config; update_config('$CONFIG_FILE', 'profile_path', '$PROFILE_PATH')"
                    if [ $? -eq 0 ]; then
                        echo "‚úÖ Switched to profile: $PROFILE_NAME"
                    else
                         echo "‚ùå Failed to update config."
                    fi
                else
                    echo "üëå Saved, but kept current profile."
                fi
                ;;
            use)
                PROFILE_NAME="$1"
                if [ -z "$PROFILE_NAME" ]; then
                    echo "Usage: genwal profile use <name>"
                    exit 1
                fi
                
                # Try to find the file
                PROFILE_PATH="profiles/$PROFILE_NAME.md"
                
                cd "$INSTALL_DIR" || exit 1
                # Update config
                "$PYTHON_CMD" -c "from src.utils import update_config; update_config('$CONFIG_FILE', 'profile_path', '$PROFILE_PATH')"
                
                if [ $? -eq 0 ]; then
                    echo "‚úÖ Switched to profile: $PROFILE_NAME"
                else
                    echo "‚ùå Failed to update config."
                fi
                ;;
            *)
                echo "Usage: genwal profile {list|use}"
                ;;
        esac
        ;;
    status)
        systemctl --user status gen-wal.timer
        ;;
    help|*)
        echo "Usage: genwal {config|logs|run|profile|status}"
        echo ""
        echo "  config        - Edit configuration file"
        echo "  logs          - View service logs"
        echo "  run           - Trigger wallpaper generation"
        echo "  profile list  - List available profiles"
        echo "  profile use   - Switch to a different profile"
        echo "  profile edit  - Create or edit a profile"
        echo "  status        - Check schedule status"
        echo ""
        echo "Examples:"
        echo "  genwal run --text-pos center"
        echo "  genwal profile use examples/builder"
        ;;
esac
